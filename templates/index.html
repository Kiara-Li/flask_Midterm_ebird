{% extends "base.html" %}
{% block content %}
<body style="background-color:#111; color:white; text-align:center;">
  <h2>å½“ä½ ç¡è§‰æ—¶ï¼Œé¸Ÿå„¿åœ¨å¹²ä»€ä¹ˆ ğŸ¦ğŸ’¤</h2>

  <form action="/sleep" method="post" style="margin-top:20px;">
    <!-- ç¡è§‰æ—¶é—´ -->
    <div style="margin:10px 0;">
      å…¥ç¡æ—¶é—´: <input type="time" name="sleep_start" required>
      èµ·åºŠæ—¶é—´: <input type="time" name="sleep_end" required>
    </div>

    <!-- æŸ¥çœ‹å‡ å¤©å‰çš„å¤œæ™š -->
    <div style="margin:10px 0;">
      æŸ¥çœ‹å“ªä¸€å¤©çš„å¤œæ™š:
      <select name="days_back">
        <option value="1">æ˜¨å¤©</option>
        <option value="2">å‰å¤©</option>
        <option value="3">å‰ä¸‰å¤©</option>
      </select>
    </div>

    <div style="margin:20px 0;">
      <button type="submit">çœ‹çœ‹é¸Ÿå„¿</button>
    </div>
  </form>

  <div style="margin-top:20px;">
    {{ map_html|safe }}
  </div>
  <script>
function loadBirdSound(name){
  // request proxy URL from server
  fetch('/birdsound?name='+encodeURIComponent(name))
    .then(r=>r.json())
    .then(data=>{
      if(!data.url){
        alert('No recording found for ' + name);
        return;
      }
      const divId = 'audio-' + name.replace(/ /g,'_').replace(/'/g,'');
      // try to find container in parent document or inside any same-origin iframes
      let container = document.getElementById(divId);
      if(!container){
        for(const ifr of document.querySelectorAll('iframe')){
          try{
            const doc = ifr.contentDocument || ifr.contentWindow.document;
            const el = doc.getElementById(divId);
            if(el){ container = el; break; }
          }catch(e){
            /* cross-origin or other access error - ignore */
          }
        }
      }
      if(!container){
        console.warn('audio container not found:', divId);
        return;
      }
      // insert audio element
      container.innerHTML = '<audio controls src="' + data.url + '"></audio>';
    })
    .catch(e=>{
      console.error('loadBirdSound error', e);
      alert('Failed to load audio');
    });
}
</script>
</body>
{% endblock %}